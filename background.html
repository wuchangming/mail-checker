<html>
<head>
<script type="text/javascript" src="src/utilize.js"></script>
<script type="text/javascript" src="src/animation.js" ></script>
<script type="text/javascript" src="src/checkmailclass.js" ></script>

<script type="text/javascript" src="src/163.js" ></script>
<script type="text/javascript" src="src/126.js" ></script>
<script>

var canvas;
var canvasContext;
var loggedInImage;
var requestFailureCount = 0;  // used for exponential backoff
var requestTimeout = 1000 * 2;  // 5 seconds

var unreadCount = "";
var loadingAnimation = new LoadingAnimation();
var checker = new CheckMailClass();

if (!chrome.cookies) {
	chrome.cookies = chrome.experimental.cookies;
}
    
// A "loading" animation displayed while we wait for the first response from
// Gmail. This animates the badge text with a dot that cycles from left to
// right.

chrome.tabs.onUpdated.addListener(function(tabId, changeInfo) {
	if (changeInfo.url && checker.isEmailUrl(changeInfo.url)) {
		checker.getInboxCount(function(count) {
			updateUnreadCount(count);
			});
	}
});

function init() {
	canvas = document.getElementById('canvas');
	loggedInImage = document.getElementById('logged_in');
	canvasContext = canvas.getContext('2d');
  
	unreadCount = "";
	
	if(typeof(localStorage.password)=="undefined" || localStorage.password.length<6) 
	{
		chrome.browserAction.setIcon({path: checker.email_not_logged_in_ico});
		return;
	}
  
	checker.init(localStorage.mailserver);

	chrome.browserAction.setBadgeBackgroundColor({color:[208, 0, 24, 255]});
	chrome.browserAction.setIcon({path: checker.email_logged_in_ico});
	loadingAnimation.start();

	startRequest();
}

function scheduleRequest() {
	window.setTimeout(startRequest, localStorage.checkcycle * 1000 * 60);
}

function startRequest() {
	//console.debug('mail:' + localStorage.email )
	//console.debug('password:' + localStorage.password )
	//console.debug('checkcycle:' + localStorage.checkcycle )
	//console.debug('displayall:' + localStorage.displayall )
	//console.debug('mailserver:' + localStorage.mailserver )
  
	if(typeof(localStorage.password)=="undefined" || localStorage.password.length<6) 
	{
		//window.setTimeout(startRequest, 1000 * 10);
		return;
	}

	checker.getInboxCount(
		function(count) {
			loadingAnimation.stop();
			updateUnreadCount(count);
			scheduleRequest();
		},
		function() {
			loadingAnimation.stop();
			showLoggedOut();
			scheduleRequest();
		}
	);
}

function updateUnreadCount(count) {
	if (unreadCount != count) {
		unreadCount = count;
		animateFlip();
	}
}

function showLoggedOut() {
	unreadCount = "";
	chrome.browserAction.setIcon({path:checker.mail_not_logged_in_ico});
	chrome.browserAction.setBadgeBackgroundColor({color:[190, 190, 190, 230]});
	chrome.browserAction.setBadgeText({text:"?"});
}

function goToInbox() {
	chrome.tabs.getAllInWindow(undefined, function(tabs) {
		for (var i = 0, tab; tab = tabs[i]; i++) {
			if (tab.url && checker.isEmailUrl(tab.url)) {
				chrome.tabs.update(tab.id, {selected: true});
				return;
			}
		}
		chrome.tabs.create({url: checker.getEmailUrl()});
	});
}

// Called when the user clicks on the browser action.
chrome.browserAction.onClicked.addListener(function(tab) {
	goToInbox();
});

</script>
</head>
<body onload="init()">
<img id="logged_in" src="icons/163/email_logged_in.png">
<canvas id="canvas" width="19" height="19">
</body>
</html>

